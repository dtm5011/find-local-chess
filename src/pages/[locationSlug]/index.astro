---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { sanityClient } from 'sanity:client';
import { slugifyLocation } from '../../lib/utils';

const { locationSlug } = Astro.params;

// Find the location name by reverse-looking up from all events
const allLocationsQuery = `*[_type == "event" && !(_id in path("drafts.**"))]{
  "location": location,
}`;

const allEvents = await sanityClient.fetch(allLocationsQuery);
const allLocations = [...new Set(allEvents.map(event => event.location))];

// Find the location that matches this slug
const location = allLocations.find(loc => slugifyLocation(loc) === locationSlug);

if (!location) {
  return Astro.redirect('/404');
}

const query = `*[_type == "event" && location == $location && !(_id in path("drafts.**"))]{
  ...,
  "slug": slug.current
}`;

const events = await sanityClient.fetch(query, { location });
---

<BaseLayout title={`Events in ${location}`}>
  <div class="container">
    <h1>Events in {location}</h1>
    <ul>
      {events.map(event => (
        <li>
          <a href={`/${locationSlug}/events/${event.slug}`}>{event.title}</a>
        </li>
      ))}
    </ul>
  </div>
</BaseLayout>